import{g as B,j as e,r as s,u as T}from"./index-g3GU5JoN.js";import{g as I,p as O}from"./http-vazCWv24.js";import{g as $}from"./auth-D6vILSCL.js";import{g as N,c as D,a as P,b as G}from"./sos-BZWgVO14.js";import{s as V}from"./geocode-Cak2rTCs.js";async function H(t){const o=B();if(!o)throw new Error("Not authenticated");return O("/checkins",t,o)}async function Y(t=30){const o=B();if(!o)throw new Error("Not authenticated");return I(`/checkins/me?limit=${t}`,o)}const Q={1:"Very low",2:"Low",3:"Okay",4:"Good",5:"Great"};function Z(t){const o=new Date(t),d=new Date().toDateString(),p=o.toDateString();return d===p?`Today ${o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`:o.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function J({checkin:t}){return e.jsxs("div",{style:{padding:"0.75rem 1rem",border:"1px solid #e0e0e0",borderRadius:8,marginBottom:8,backgroundColor:"#fafafa"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:4},children:[e.jsxs("span",{style:{fontWeight:600,fontSize:"1.1rem"},children:[t.mood_score," â€” ",Q[t.mood_score]??"Unknown"]}),e.jsx("span",{style:{color:"#666",fontSize:"0.9rem"},children:Z(t.created_at)})]}),t.tags.length>0&&e.jsx("div",{style:{marginTop:6,display:"flex",flexWrap:"wrap",gap:4},children:t.tags.map(o=>e.jsx("span",{style:{padding:"2px 8px",backgroundColor:"#e3f2fd",borderRadius:4,fontSize:"0.85rem"},children:o},o))}),t.note&&e.jsx("p",{style:{margin:"8px 0 0",color:"#444",fontSize:"0.95rem"},children:t.note}),t.wants_company&&e.jsx("div",{style:{marginTop:6,color:"#1976d2",fontSize:"0.9rem"},children:"Wants company"})]})}const K=[{value:1,label:"1 - Very low"},{value:2,label:"2 - Low"},{value:3,label:"3 - Okay"},{value:4,label:"4 - Good"},{value:5,label:"5 - Great"}];function X({onSubmitted:t}){const[o,l]=s.useState(3),[d,p]=s.useState(""),[y,h]=s.useState(""),[i,x]=s.useState(!1),[c,r]=s.useState(!1),[j,w]=s.useState(null);async function S(g){g.preventDefault(),w(null),r(!0);try{const b=d.split(/[,\s]+/).map(C=>C.trim()).filter(Boolean),v={mood_score:o,tags:b,note:y.trim()||void 0,wants_company:i};await H(v),l(3),p(""),h(""),x(!1),t()}catch(b){w(b instanceof Error?b.message:"Failed to submit check-in")}finally{r(!1)}}return e.jsxs("form",{onSubmit:S,style:{padding:"1rem",border:"1px solid #e0e0e0",borderRadius:8,backgroundColor:"#fff",marginBottom:"1.5rem"},children:[e.jsx("h3",{style:{marginTop:0},children:"How are you feeling today?"}),j&&e.jsx("div",{style:{color:"#c62828",marginBottom:8,fontSize:"0.9rem"},children:j}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{display:"block",marginBottom:4,fontWeight:500},children:"Mood (1â€“5)"}),e.jsx("select",{value:o,onChange:g=>l(Number(g.target.value)),style:{padding:"6px 10px",minWidth:160,borderRadius:4,border:"1px solid #ccc"},children:K.map(g=>e.jsx("option",{value:g.value,children:g.label},g.value))})]}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{display:"block",marginBottom:4,fontWeight:500},children:"Tags (comma-separated, e.g. calm, hopeful)"}),e.jsx("input",{type:"text",value:d,onChange:g=>p(g.target.value),placeholder:"calm, hopeful, tired...",style:{width:"100%",maxWidth:320,padding:"8px 10px",borderRadius:4,border:"1px solid #ccc"}})]}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("label",{style:{display:"block",marginBottom:4,fontWeight:500},children:"Note (optional)"}),e.jsx("textarea",{value:y,onChange:g=>h(g.target.value),placeholder:"How are you doing?",rows:2,style:{width:"100%",maxWidth:320,padding:"8px 10px",borderRadius:4,border:"1px solid #ccc",resize:"vertical"}})]}),e.jsx("div",{style:{marginBottom:16},children:e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:8,cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:i,onChange:g=>x(g.target.checked)}),e.jsx("span",{children:"I'd like company today"})]})}),e.jsx("button",{type:"submit",disabled:c,style:{padding:"8px 20px",cursor:c?"wait":"pointer"},children:c?"Submitting...":"Submit check-in"})]})}async function q(t){const o=B();if(!o)throw new Error("Not authenticated");return O("/presence",{status:t},o)}async function W(t,o){const l=B();if(!l)throw new Error("Not authenticated");return O("/location",{latitude:t,longitude:o},l)}async function U(t=10){const o=B();if(!o)throw new Error("Not authenticated");return I(`/buddies/nearby?limit=${t}`,o)}const A=[{value:"AVAILABLE",label:"Available",color:"#2e7d32"},{value:"BUSY",label:"Busy",color:"#e65100"},{value:"OFFLINE",label:"Offline",color:"#757575"}];function ee({initialStatus:t="OFFLINE",onUpdated:o}){const[l,d]=s.useState(t),[p,y]=s.useState(!1),[h,i]=s.useState(null);async function x(r){y(!0),i(null);try{await q(r),d(r),o==null||o()}catch(j){i(j instanceof Error?j.message:"Failed to update")}finally{y(!1)}}const c=A.find(r=>r.value===l);return e.jsxs("div",{style:{padding:"0.75rem 1rem",border:"1px solid #e0e0e0",borderRadius:8,backgroundColor:"#fff",marginBottom:"1rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"},children:[e.jsx("span",{style:{fontWeight:600},children:"My Status:"}),e.jsx("span",{style:{display:"inline-block",width:10,height:10,borderRadius:"50%",backgroundColor:(c==null?void 0:c.color)??"#757575"}}),e.jsx("span",{style:{color:c==null?void 0:c.color,fontWeight:500},children:c==null?void 0:c.label}),e.jsx("div",{style:{display:"flex",gap:6,marginLeft:"auto"},children:A.map(r=>e.jsx("button",{type:"button",onClick:()=>x(r.value),disabled:p||l===r.value,style:{padding:"4px 12px",fontSize:"0.85rem",borderRadius:4,border:l===r.value?`2px solid ${r.color}`:"1px solid #ccc",backgroundColor:l===r.value?`${r.color}15`:"#fff",color:r.color,cursor:p||l===r.value?"default":"pointer",fontWeight:l===r.value?600:400},children:r.label},r.value))})]}),h&&e.jsx("p",{style:{color:"#c62828",margin:"6px 0 0",fontSize:"0.85rem"},children:h})]})}function te({onUpdated:t}){const[o,l]=s.useState(""),[d,p]=s.useState([]),[y,h]=s.useState(!1),[i,x]=s.useState(null),[c,r]=s.useState(""),[j,w]=s.useState(!1),[S,g]=s.useState(!1),[b,v]=s.useState(null),[C,L]=s.useState(!1),[R,n]=s.useState(!0);s.useEffect(()=>{async function a(){try{const f=B();if(!f)return;const m=await $(f);if(m.latitude&&m.longitude){x({lat:m.latitude,lng:m.longitude});try{const _=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${m.latitude}&lon=${m.longitude}&format=json`,{headers:{"Accept-Language":"en"}});if(_.ok){const F=(await _.json()).display_name||`${m.latitude.toFixed(4)}, ${m.longitude.toFixed(4)}`;r(F),l(F)}else r(`${m.latitude.toFixed(4)}, ${m.longitude.toFixed(4)}`)}catch{r(`${m.latitude.toFixed(4)}, ${m.longitude.toFixed(4)}`)}}}catch{}finally{n(!1)}}a()},[]);async function u(a){l(a),L(!1),r(""),h(!0);const f=await V(a);p(f),h(!1)}async function k(a){l(a.display_name),r(a.display_name),p([]),x({lat:a.lat,lng:a.lon}),v(null),w(!0);try{await W(a.lat,a.lon),L(!0),t==null||t()}catch(f){v(f instanceof Error?f.message:"Failed to update location")}finally{w(!1)}}async function E(){g(!0),v(null),L(!1);try{const a=await fetch("https://ipapi.co/json/");if(!a.ok)throw new Error("IP geolocation service unavailable");const f=await a.json();if(f.latitude&&f.longitude){const m=f.latitude,_=f.longitude;x({lat:m,lng:_});const z=[f.city,f.region,f.country_name].filter(Boolean).join(", ");r(z||`${m.toFixed(4)}, ${_.toFixed(4)}`),l(z||""),await W(m,_),L(!0),t==null||t()}else throw new Error("Could not determine location from IP")}catch(a){v(a instanceof Error?a.message:"Auto-detect failed. Please type your address above.")}finally{g(!1)}}return R?e.jsxs("div",{style:{padding:"1rem",border:"1px solid #e0e0e0",borderRadius:10,backgroundColor:"#fff",marginBottom:"1rem"},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8},children:"My Location"}),e.jsx("p",{style:{color:"#888",fontSize:"0.85rem",margin:0},children:"Loading saved location..."})]}):e.jsxs("div",{style:{padding:"1rem",border:"1px solid #e0e0e0",borderRadius:10,backgroundColor:"#fff",marginBottom:"1rem"},children:[e.jsx("div",{style:{fontWeight:600,marginBottom:8},children:"My Location"}),i&&c&&!C&&e.jsxs("div",{style:{padding:"8px 12px",backgroundColor:"#e3f2fd",borderRadius:6,marginBottom:10,fontSize:"0.85rem",color:"#1565c0"},children:["Current: ",c.split(",").slice(0,3).join(", ")]}),e.jsxs("div",{style:{position:"relative",marginBottom:8},children:[e.jsx("input",{type:"text",value:o,onChange:a=>u(a.target.value),placeholder:"Type city, ZIP code, or address to update...",style:{width:"100%",padding:"10px 12px",border:`2px solid ${C?"#43a047":"#e0e0e0"}`,borderRadius:8,fontSize:"0.9rem",outline:"none",backgroundColor:"#fafafa",boxSizing:"border-box"}}),y&&e.jsx("span",{style:{position:"absolute",right:12,top:"50%",transform:"translateY(-50%)",fontSize:"0.75rem",color:"#999"},children:"Searching..."})]}),d.length>0&&e.jsx("div",{style:{border:"1px solid #e0e0e0",borderRadius:8,marginBottom:8,maxHeight:180,overflowY:"auto",backgroundColor:"#fff",boxShadow:"0 4px 12px rgba(0,0,0,0.08)"},children:d.map((a,f)=>e.jsxs("button",{type:"button",onClick:()=>k(a),style:{display:"block",width:"100%",padding:"8px 12px",border:"none",borderBottom:f<d.length-1?"1px solid #f0f0f0":"none",backgroundColor:"#fff",textAlign:"left",cursor:"pointer",fontSize:"0.83rem",color:"#333"},onMouseEnter:m=>{m.currentTarget.style.backgroundColor="#f5f5f5"},onMouseLeave:m=>{m.currentTarget.style.backgroundColor="#fff"},children:[e.jsx("span",{style:{fontWeight:500},children:a.display_name.split(",")[0]}),e.jsx("span",{style:{color:"#888",fontSize:"0.78rem"},children:a.display_name.includes(",")?", "+a.display_name.split(",").slice(1,3).join(",").trim():""})]},f))}),e.jsxs("button",{type:"button",onClick:E,disabled:S,style:{padding:"6px 14px",background:"#fff",border:"1px solid #ccc",borderRadius:6,cursor:S?"default":"pointer",fontSize:"0.83rem",color:"#555",display:"flex",alignItems:"center",gap:6,marginBottom:8},children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:"ðŸ“"}),S?"Detecting...":"Auto-detect my location"]}),j&&e.jsx("p",{style:{color:"#1976d2",margin:"4px 0 0",fontSize:"0.83rem"},children:"Saving location..."}),C&&i&&e.jsxs("p",{style:{color:"#2e7d32",margin:"4px 0 0",fontSize:"0.83rem"},children:["Location updated: ",c?c.split(",").slice(0,2).join(", "):`${i.lat.toFixed(4)}, ${i.lng.toFixed(4)}`]}),b&&e.jsx("p",{style:{color:"#c62828",margin:"4px 0 0",fontSize:"0.83rem"},children:b})]})}const M={AVAILABLE:"#2e7d32",BUSY:"#e65100",OFFLINE:"#757575"};function oe(){const[t,o]=s.useState([]),[l,d]=s.useState(!0),[p,y]=s.useState(null);async function h(){y(null),d(!0);try{const i=await U(10);o(i)}catch(i){y(i instanceof Error?i.message:"Failed to load nearby buddies")}finally{d(!1)}}return s.useEffect(()=>{h()},[]),l?e.jsx("p",{style:{color:"#666"},children:"Loading nearby buddies..."}):p?e.jsx("p",{style:{color:"#c62828"},children:p}):t.length===0?e.jsx("p",{style:{color:"#666"},children:"No accepted buddies found."}):e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8},children:[e.jsx("span",{style:{fontSize:"0.85rem",color:"#666"},children:"Ranked by availability, trust, and distance"}),e.jsx("button",{type:"button",onClick:h,style:{padding:"4px 10px",fontSize:"0.8rem"},children:"Refresh"})]}),t.map((i,x)=>e.jsxs("div",{style:{padding:"0.6rem 1rem",border:"1px solid #e0e0e0",borderRadius:8,marginBottom:6,backgroundColor:"#fff",display:"flex",alignItems:"center",gap:12},children:[e.jsxs("span",{style:{color:"#999",fontWeight:600,minWidth:24},children:["#",x+1]}),e.jsx("span",{style:{display:"inline-block",width:8,height:8,borderRadius:"50%",backgroundColor:M[i.presence_status]??"#757575",flexShrink:0}}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:500},children:i.buddy_name}),e.jsxs("div",{style:{fontSize:"0.85rem",color:"#666"},children:[i.buddy_email," â€” trust ",i.trust_level,"/5"]})]}),e.jsxs("div",{style:{textAlign:"right",fontSize:"0.85rem"},children:[e.jsx("div",{style:{color:M[i.presence_status],fontWeight:500},children:i.presence_status}),i.distance_km!==null&&e.jsxs("div",{style:{color:"#666"},children:[i.distance_km<1?"<1":Math.round(i.distance_km)," km"]})]})]},i.buddy_id))]})}function le(){const[t,o]=s.useState([]),[l,d]=s.useState([]),[p,y]=s.useState(!0),[h,i]=s.useState(""),[x,c]=s.useState(""),[r,j]=s.useState(null),[w,S]=s.useState(null),[g,b]=s.useState(!1);async function v(){j(null);try{const n=B();if(!n){j("No token found. Please log in again."),y(!1);return}const u=await $(n);i(u.role),c(u.full_name);const k=await Y(7);if(o(k),u.role==="veteran"){const E=await N(10);d(E)}else d([])}catch(n){j(n instanceof Error?n.message:"Failed to load dashboard. Your session may have expired â€” please log in again."),o([]),d([])}finally{y(!1)}}s.useEffect(()=>{v()},[]),T(["sos.recipient_updated","sos.closed"],()=>{h==="veteran"&&N(10).then(d).catch(()=>{})});async function C(n){S(null),b(!0);try{const u=await D(n);d(k=>[u,...k])}catch(u){S(u instanceof Error?u.message:"Failed to create SOS")}finally{b(!1)}}async function L(n){S(null),b(!0);try{const u=await P(n);d(k=>[u,...k])}catch(u){S(u instanceof Error?u.message:"Failed to create SOS from check-in")}finally{b(!1)}}async function R(n){try{const u=await G(n);d(k=>k.map(E=>E.id===n?u:E))}catch{}}return p?e.jsx("div",{children:"Loading..."}):e.jsxs("div",{style:{maxWidth:600,margin:"0 auto",padding:"1rem"},children:[e.jsx("h1",{children:"Dashboard"}),e.jsxs("p",{children:["Welcome",x?`, ${x}`:""," to VetBridge â€” Veteran Buddy Matching"]}),r&&e.jsxs("div",{style:{padding:"1rem",backgroundColor:"#ffebee",border:"1px solid #ef9a9a",borderRadius:8,marginBottom:"1rem"},children:[e.jsx("p",{style:{color:"#c62828",margin:0},children:r}),e.jsx("a",{href:"/login",style:{color:"#1976d2",marginTop:8,display:"inline-block"},children:"Go to Login"})]}),h&&e.jsxs("section",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{children:"Status & Location"}),e.jsx(ee,{}),e.jsx(te,{})]}),h==="veteran"&&e.jsxs(e.Fragment,{children:[e.jsxs("section",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{children:"Nearby Buddies"}),e.jsx("p",{style:{fontSize:"0.9rem",color:"#666",marginBottom:8},children:"These are the buddies who will be notified during SOS"}),e.jsx(oe,{})]}),e.jsxs("section",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{children:"Mood Check-in"}),e.jsx(X,{onSubmitted:v}),e.jsx("h3",{children:"Recent check-ins (last 7)"}),t.length===0?e.jsx("p",{style:{color:"#666"},children:"No check-ins yet. Submit your first one above."}):e.jsx("div",{children:t.map(n=>e.jsxs("div",{style:{marginBottom:8},children:[e.jsx(J,{checkin:n}),(n.wants_company||n.mood_score<=2)&&e.jsx("button",{type:"button",onClick:()=>L(n.id),disabled:g,style:{marginTop:4,padding:"4px 12px",fontSize:"0.85rem"},children:"Create SOS from this check-in"})]},n.id))})]}),e.jsxs("section",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{children:"SOS Alerts"}),w&&e.jsx("p",{style:{color:"#c62828",marginBottom:8},children:w}),e.jsxs("div",{style:{marginBottom:12},children:[e.jsx("span",{style:{marginRight:8},children:"Manual SOS:"}),["LOW","MED","HIGH"].map(n=>e.jsx("button",{type:"button",onClick:()=>C(n),disabled:g,style:{marginRight:8,padding:"6px 14px"},children:n},n))]}),l.length===0?e.jsx("p",{style:{color:"#666"},children:"No SOS alerts yet."}):e.jsx("div",{children:l.map(n=>e.jsxs("div",{style:{padding:"1rem",border:"1px solid #e0e0e0",borderRadius:8,marginBottom:8,backgroundColor:"#fff"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsxs("strong",{children:["SOS #",n.id," â€” ",n.trigger_type," / ",n.severity]}),e.jsx("span",{style:{marginLeft:8,color:n.status==="OPEN"?"#c62828":"#666"},children:n.status})]}),n.status==="OPEN"&&e.jsx("button",{type:"button",onClick:()=>R(n.id),style:{padding:"4px 12px"},children:"Close"})]}),e.jsxs("div",{style:{marginTop:8,fontSize:"0.9rem",color:"#666"},children:["Recipients: ",n.recipients.map(u=>`${u.buddy_name} (${u.status})`).join(", ")]})]},n.id))})]})]}),h!=="veteran"&&h&&e.jsx("p",{style:{color:"#666"},children:"Mood check-ins and SOS are available for veterans."})]})}export{le as default};
