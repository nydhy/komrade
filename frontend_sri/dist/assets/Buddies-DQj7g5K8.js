import{r as l,j as e,k as p,w as N,l as w,m as E,n as C,f as S}from"./index-BjFXoSI1.js";import{a as _}from"./auth-CXLfW215.js";function L({onInvited:n,existingLinks:a=[]}){const[d,o]=l.useState(""),[r,x]=l.useState(3),[u,i]=l.useState(""),[h,m]=l.useState(""),[t,s]=l.useState(!1);function g(c){const v=c.toLowerCase().trim(),f=a.find(j=>j.other_email.toLowerCase()===v);return f?f.status==="ACCEPTED"?"You are already friends with this user.":f.status==="PENDING"?"A friend request is already pending with this user.":f.status==="BLOCKED"?"This connection has been blocked.":null:null}async function b(c){c.preventDefault(),i(""),m("");const v=g(d);if(v){i(v);return}s(!0);try{await p({buddy_email:d,trust_level:r}),m(`Friend request sent to ${d}!`),o(""),n()}catch(f){i(f instanceof Error?f.message:"Invite failed")}finally{s(!1)}}return e.jsxs("div",{className:"card card-glow",children:[e.jsx("h3",{className:"heading-sm mb-4",children:"Add a Friend"}),e.jsxs("form",{onSubmit:b,className:"flex-col gap-md",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Email address"}),e.jsx("input",{type:"email",className:"input",placeholder:"Enter friend's email",value:d,onChange:c=>{o(c.target.value),i(""),m("")},required:!0})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Trust level"}),e.jsx("select",{className:"select",value:r,onChange:c=>x(Number(c.target.value)),children:[1,2,3,4,5].map(c=>e.jsxs("option",{value:c,children:["Trust ",c]},c))})]})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:t,children:t?"Sending…":"Send Request"})}),u&&e.jsx("div",{className:"alert alert-danger animate-in",children:u}),h&&e.jsx("div",{className:"alert alert-success animate-in",children:h})]})]})}async function A(n,a){try{const d=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${n}&lon=${a}&format=json&zoom=12`);if(!d.ok)return`${n.toFixed(2)}, ${a.toFixed(2)}`;const o=await d.json(),r=o.address||{};return[r.city||r.town||r.village||r.county,r.state,r.country].filter(Boolean).join(", ")||o.display_name||`${n.toFixed(2)}, ${a.toFixed(2)}`}catch{return`${n.toFixed(2)}, ${a.toFixed(2)}`}}const B={ACCEPTED:"badge badge-success",PENDING:"badge badge-warning",BLOCKED:"badge badge-danger"},y=["","animate-in-delay-1","animate-in-delay-2","animate-in-delay-3","animate-in-delay-4","animate-in-delay-5"];function D({links:n,onUpdated:a}){const[d,o]=l.useState({}),[r,x]=l.useState(null);l.useEffect(()=>{const t=n.filter(s=>s.status==="ACCEPTED"&&s.other_latitude!=null&&s.other_longitude!=null&&!d[s.id]);t.length!==0&&t.forEach((s,g)=>{setTimeout(()=>{A(s.other_latitude,s.other_longitude).then(b=>o(c=>({...c,[s.id]:b})))},g*400)})},[n]);async function u(t){try{await w(t),a()}catch(s){alert(s instanceof Error?s.message:"Accept failed")}}async function i(t){try{await E(t),a()}catch(s){alert(s instanceof Error?s.message:"Block failed")}}async function h(t){if(confirm("Withdraw this buddy request?")){x(t),a(t);try{await N(t),a()}catch(s){a(),alert(s instanceof Error?s.message:"Withdraw failed")}finally{x(null)}}}async function m(t){if(confirm("Remove this buddy? This will delete the connection entirely."))try{await C(t),a()}catch(s){alert(s instanceof Error?s.message:"Remove failed")}}return n.length===0?e.jsx("div",{className:"card flex-center animate-in",style:{minHeight:120},children:e.jsx("p",{className:"text-muted",children:"No buddy links yet. Send an invite above to get started!"})}):e.jsx("div",{className:"flex-col gap-md",children:n.map((t,s)=>{const g=y[Math.min(s,y.length-1)],b=(t.other_name||t.other_email).charAt(0).toUpperCase();return e.jsx("div",{className:`card card-hover animate-in ${g}`,children:e.jsxs("div",{className:"flex-between",children:[e.jsxs("div",{className:"flex-center gap-md",children:[e.jsx("div",{className:"avatar",style:{background:"var(--gradient-accent)"},children:b}),e.jsxs("div",{className:"flex-col gap-xs",children:[e.jsxs("div",{className:"flex-center gap-sm",children:[e.jsx("span",{className:"heading-sm",children:t.other_name||"Unknown"}),e.jsx("span",{className:B[t.status]||"badge",children:t.status})]}),e.jsx("span",{className:"text-secondary text-sm",children:t.other_email}),e.jsxs("span",{className:"text-xs text-muted",children:["Trust level ",t.trust_level]}),t.status==="ACCEPTED"&&e.jsx("span",{className:"text-xs",children:t.other_latitude!=null&&t.other_longitude!=null?e.jsx("span",{style:{color:"var(--accent-primary)"},children:d[t.id]||"Resolving location…"}):e.jsx("span",{className:"text-muted",children:"Location not set"})})]})]}),e.jsxs("div",{className:"flex-center gap-sm",children:[t.status==="PENDING"&&t.is_sender&&e.jsx("button",{className:"btn btn-warning btn-sm",onClick:()=>h(t.id),disabled:r===t.id,children:r===t.id?"Withdrawing...":"Withdraw"}),t.status==="PENDING"&&!t.is_sender&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>u(t.id),children:"Accept"}),e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>i(t.id),children:"Decline"})]}),t.status==="ACCEPTED"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>i(t.id),children:"Block"}),e.jsx("button",{className:"btn btn-ghost btn-sm",onClick:()=>m(t.id),children:"Remove"})]})]})]})},t.id)})})}function P(){const[n,a]=l.useState([]),[d,o]=l.useState(!0),[r,x]=l.useState("");async function u(){try{const i=localStorage.getItem("vetbridge_token");if(i){const[h,m]=await Promise.all([_(i),S()]);x(h.role),a(m)}}catch{a([])}finally{o(!1)}}return l.useEffect(()=>{u()},[]),d?e.jsx("div",{className:"page-container flex-center",style:{minHeight:"60vh"},children:e.jsxs("div",{className:"card flex-center gap-md animate-in",children:[e.jsx("div",{className:"animate-spin",style:{width:24,height:24,border:"3px solid var(--border-default)",borderTopColor:"var(--accent-primary)",borderRadius:"50%"}}),e.jsx("span",{className:"text-secondary",children:"Loading buddies…"})]})}):e.jsxs("div",{className:"page-container page-container-narrow",children:[e.jsxs("div",{className:"animate-in mb-8",children:[e.jsx("h1",{className:"heading-lg mb-2",children:"My Buddies"}),e.jsx("p",{className:"text-secondary",children:"Manage your connections and friend requests"})]}),e.jsx("div",{className:"animate-in animate-in-delay-1 mb-8",children:e.jsx(L,{onInvited:u,existingLinks:n})}),e.jsxs("div",{className:"animate-in animate-in-delay-2",children:[e.jsx("h2",{className:"heading-md mb-4",children:"Buddy Links"}),e.jsx(D,{links:n,onUpdated:i=>{i!==void 0&&a(h=>h.filter(m=>m.id!==i)),u()}})]})]})}export{P as default};
