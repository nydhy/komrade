import{r as d,j as e,k as y,l as b,m as E,f as C}from"./index-D1iaHaPw.js";import{g as S}from"./auth-Dz8uO1Cl.js";function w({onInvited:a,existingLinks:n=[]}){const[r,l]=d.useState(""),[i,h]=d.useState(3),[s,t]=d.useState(""),[u,o]=d.useState(""),[x,f]=d.useState(!1);function v(c){const g=c.toLowerCase().trim(),m=n.find(N=>N.other_email.toLowerCase()===g);return m?m.status==="ACCEPTED"?"You are already friends with this user.":m.status==="PENDING"?"A friend request is already pending with this user.":m.status==="BLOCKED"?"This connection has been blocked.":null:null}async function j(c){c.preventDefault(),t(""),o("");const g=v(r);if(g){t(g);return}f(!0);try{await y({buddy_email:r,trust_level:i}),o(`Friend request sent to ${r}!`),l(""),a()}catch(m){t(m instanceof Error?m.message:"Invite failed")}finally{f(!1)}}return e.jsxs("div",{className:"card card-glow",children:[e.jsx("h3",{className:"heading-sm mb-4",children:"Add a Friend"}),e.jsxs("form",{onSubmit:j,className:"flex-col gap-md",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Email address"}),e.jsx("input",{type:"email",className:"input",placeholder:"Enter friend's email",value:r,onChange:c=>{l(c.target.value),t(""),o("")},required:!0})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Trust level"}),e.jsx("select",{className:"select",value:i,onChange:c=>h(Number(c.target.value)),children:[1,2,3,4,5].map(c=>e.jsxs("option",{value:c,children:["Trust ",c]},c))})]})]}),e.jsx("div",{children:e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:x,children:x?"Sending…":"Send Request"})}),s&&e.jsx("div",{className:"alert alert-danger animate-in",children:s}),u&&e.jsx("div",{className:"alert alert-success animate-in",children:u})]})]})}async function _(a,n){try{const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${a}&lon=${n}&format=json&zoom=12`);if(!r.ok)return`${a.toFixed(2)}, ${n.toFixed(2)}`;const l=await r.json(),i=l.address||{};return[i.city||i.town||i.village||i.county,i.state,i.country].filter(Boolean).join(", ")||l.display_name||`${a.toFixed(2)}, ${n.toFixed(2)}`}catch{return`${a.toFixed(2)}, ${n.toFixed(2)}`}}const L={ACCEPTED:"badge badge-success",PENDING:"badge badge-warning",BLOCKED:"badge badge-danger"},p=["","animate-in-delay-1","animate-in-delay-2","animate-in-delay-3","animate-in-delay-4","animate-in-delay-5"];function A({links:a,onUpdated:n}){const[r,l]=d.useState({});d.useEffect(()=>{const s=a.filter(t=>t.status==="ACCEPTED"&&t.other_latitude!=null&&t.other_longitude!=null&&!r[t.id]);s.length!==0&&s.forEach((t,u)=>{setTimeout(()=>{_(t.other_latitude,t.other_longitude).then(o=>l(x=>({...x,[t.id]:o})))},u*400)})},[a]);async function i(s){try{await b(s),n()}catch(t){alert(t instanceof Error?t.message:"Accept failed")}}async function h(s){try{await E(s),n()}catch(t){alert(t instanceof Error?t.message:"Block failed")}}return a.length===0?e.jsx("div",{className:"card flex-center animate-in",style:{minHeight:120},children:e.jsx("p",{className:"text-muted",children:"No buddy links yet. Send an invite above to get started!"})}):e.jsx("div",{className:"flex-col gap-md",children:a.map((s,t)=>{const u=p[Math.min(t,p.length-1)],o=(s.other_name||s.other_email).charAt(0).toUpperCase();return e.jsx("div",{className:`card card-hover animate-in ${u}`,children:e.jsxs("div",{className:"flex-between",children:[e.jsxs("div",{className:"flex-center gap-md",children:[e.jsx("div",{className:"avatar",style:{background:"var(--gradient-accent)"},children:o}),e.jsxs("div",{className:"flex-col gap-xs",children:[e.jsxs("div",{className:"flex-center gap-sm",children:[e.jsx("span",{className:"heading-sm",children:s.other_name||"Unknown"}),e.jsx("span",{className:L[s.status]||"badge",children:s.status})]}),e.jsx("span",{className:"text-secondary text-sm",children:s.other_email}),e.jsxs("span",{className:"text-xs text-muted",children:["Trust level ",s.trust_level]}),s.status==="ACCEPTED"&&e.jsx("span",{className:"text-xs",children:s.other_latitude!=null&&s.other_longitude!=null?e.jsx("span",{style:{color:"var(--accent-primary)"},children:r[s.id]||"Resolving location…"}):e.jsx("span",{className:"text-muted",children:"Location not set"})})]})]}),e.jsxs("div",{className:"flex-center gap-sm",children:[s.status==="PENDING"&&e.jsx("button",{className:"btn btn-success btn-sm",onClick:()=>i(s.id),children:"Accept"}),(s.status==="PENDING"||s.status==="ACCEPTED")&&e.jsx("button",{className:"btn btn-danger btn-sm",onClick:()=>h(s.id),children:"Block"})]})]})},s.id)})})}function T(){const[a,n]=d.useState([]),[r,l]=d.useState(!0),[i,h]=d.useState("");async function s(){try{const t=localStorage.getItem("vetbridge_token");if(t){const[u,o]=await Promise.all([S(t),C()]);h(u.role),n(o)}}catch{n([])}finally{l(!1)}}return d.useEffect(()=>{s()},[]),r?e.jsx("div",{className:"page-container flex-center",style:{minHeight:"60vh"},children:e.jsxs("div",{className:"card flex-center gap-md animate-in",children:[e.jsx("div",{className:"animate-spin",style:{width:24,height:24,border:"3px solid var(--border-default)",borderTopColor:"var(--accent-primary)",borderRadius:"50%"}}),e.jsx("span",{className:"text-secondary",children:"Loading buddies…"})]})}):e.jsxs("div",{className:"page-container page-container-narrow",children:[e.jsxs("div",{className:"animate-in mb-8",children:[e.jsx("h1",{className:"heading-lg mb-2",children:"My Buddies"}),e.jsx("p",{className:"text-secondary",children:"Manage your connections and friend requests"})]}),e.jsx("div",{className:"animate-in animate-in-delay-1 mb-8",children:e.jsx(w,{onInvited:s,existingLinks:a})}),e.jsxs("div",{className:"animate-in animate-in-delay-2",children:[e.jsx("h2",{className:"heading-md mb-4",children:"Buddy Links"}),e.jsx(A,{links:a,onUpdated:s})]})]})}export{T as default};
