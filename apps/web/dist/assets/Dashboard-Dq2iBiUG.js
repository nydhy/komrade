import{g as I,a as W,p as H,j as e,r as s,c as R,b as U,u as Y,d as z,e as Q,f as K}from"./index-D1iaHaPw.js";import{g as G}from"./auth-Dz8uO1Cl.js";import{s as Z}from"./geocode-Cak2rTCs.js";async function J(t){const c=I();if(!c)throw new Error("Not authenticated");return H("/checkins",t,c)}async function X(t=30){const c=I();if(!c)throw new Error("Not authenticated");return W(`/checkins/me?limit=${t}`,c)}const q={1:"Very low",2:"Low",3:"Okay",4:"Good",5:"Great"};function ee(t){const c=new Date(t),o=new Date().toDateString(),x=c.toDateString();return o===x?`Today ${c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`:c.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function se(t){return t<=2?"mood-score-low":t===3?"mood-score-mid":"mood-score-high"}function te({checkin:t}){return e.jsxs("div",{className:"card card-hover mb-3",children:[e.jsxs("div",{className:"flex-between mb-3",style:{flexWrap:"wrap",gap:"4px"},children:[e.jsxs("div",{className:"flex-center gap-sm",children:[e.jsx("span",{className:`mood-score-badge ${se(t.mood_score)}`,children:t.mood_score}),e.jsx("span",{className:"heading-sm",children:q[t.mood_score]??"Unknown"})]}),e.jsx("span",{className:"text-muted text-xs",children:ee(t.created_at)})]}),t.tags.length>0&&e.jsx("div",{className:"flex-center gap-xs mb-3",style:{flexWrap:"wrap",justifyContent:"flex-start"},children:t.tags.map(c=>e.jsx("span",{className:"badge",children:c},c))}),t.note&&e.jsx("p",{className:"text-secondary text-sm mb-2",children:t.note}),t.wants_company&&e.jsx("div",{className:"flex-center gap-xs mt-2",style:{justifyContent:"flex-start"},children:e.jsx("span",{className:"badge badge-info",children:"Wants company"})})]})}const ae=[{value:1,label:"1 - Very low"},{value:2,label:"2 - Low"},{value:3,label:"3 - Okay"},{value:4,label:"4 - Good"},{value:5,label:"5 - Great"}];function ne({onSubmitted:t,buddies:c,onSosCreated:m}){const[o,x]=s.useState(3),[b,h]=s.useState(""),[i,p]=s.useState(""),[S,N]=s.useState(!1),[j,u]=s.useState(!1),[k,d]=s.useState(null),[g,r]=s.useState(null),[f,w]=s.useState(!1),[O,F]=s.useState("MED"),[A,$]=s.useState(!1),[L,_]=s.useState(new Set);function B(a){_(C=>{const E=new Set(C);return E.has(a)?E.delete(a):E.add(a),E})}async function M(a){a.preventDefault(),d(null),r(null),u(!0);try{const C=b.split(/[,\s]+/).map(n=>n.trim()).filter(Boolean),E={mood_score:o,tags:C,note:i.trim()||void 0,wants_company:S},l=await J(E);{const n={};n.severity=f?O:"MED",A?n.broadcast=!0:L.size>0&&(n.buddy_ids=Array.from(L));try{const y=await R(l.id,n);m==null||m(y),r(`Check-in submitted + SOS #${String(y.id).slice(0,8)} sent!`)}catch(y){r("Check-in submitted."),d(y instanceof Error?y.message:"Check-in OK but SOS creation failed")}}x(3),h(""),p(""),N(!1),w(!1),$(!1),_(new Set),t()}catch(C){d(C instanceof Error?C.message:"Failed to submit check-in")}finally{u(!1)}}return e.jsxs("form",{onSubmit:M,className:"card mb-6",children:[e.jsx("h3",{className:"heading-sm mb-4",children:"How are you feeling today?"}),e.jsx("div",{className:"divider mb-4"}),k&&e.jsx("div",{className:"alert alert-danger mb-4 text-sm",children:k}),g&&e.jsx("div",{className:"alert alert-success mb-4 text-sm",children:g}),e.jsxs("div",{className:"flex-col gap-md",children:[e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Mood (1-5)"}),e.jsx("select",{className:"select",value:o,onChange:a=>x(Number(a.target.value)),children:ae.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Tags (comma-separated)"}),e.jsx("input",{type:"text",className:"input",value:b,onChange:a=>h(a.target.value),placeholder:"calm, hopeful, tired..."})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Note (optional)"}),e.jsx("textarea",{className:"textarea",value:i,onChange:a=>p(a.target.value),placeholder:"How are you doing?",rows:3})]}),e.jsxs("label",{className:"mood-company-checkbox",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:a=>N(a.target.checked)}),e.jsx("span",{className:"text-secondary text-sm",children:"I'd like company today"})]}),e.jsx("div",{className:"divider"}),e.jsxs("div",{className:"form-section",children:[e.jsxs("label",{className:"mood-company-checkbox",style:{marginBottom:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:f,onChange:a=>w(a.target.checked)}),e.jsx("span",{className:"text-sm",style:{fontWeight:600},children:"Send SOS Alert with this check-in"})]}),f&&e.jsxs("div",{className:"flex-col gap-sm",style:{marginTop:"0.75rem",paddingLeft:"0.5rem"},children:[e.jsxs("div",{className:"input-group",children:[e.jsx("label",{className:"text-secondary text-sm",children:"Severity"}),e.jsx("div",{className:"flex-center gap-sm mt-1",children:["LOW","MED","HIGH"].map(a=>e.jsx("button",{type:"button",className:`btn btn-sm ${O===a?a==="HIGH"?"btn-danger":a==="MED"?"btn-secondary":"btn-success":"btn-ghost"}`,onClick:()=>F(a),children:a},a))})]}),e.jsxs("label",{className:"mood-company-checkbox",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:a=>{$(a.target.checked),a.target.checked&&_(new Set)}}),e.jsx("span",{className:"text-secondary text-sm",children:"Broadcast to all buddies"})]}),!A&&c.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-secondary text-sm",style:{display:"block",marginBottom:"0.4rem"},children:"Or select specific buddies:"}),e.jsx("div",{className:"flex-col gap-xs",children:c.map(a=>e.jsxs("label",{className:"mood-company-checkbox",children:[e.jsx("input",{type:"checkbox",checked:L.has(a.id),onChange:()=>B(a.id)}),e.jsxs("span",{className:"text-sm",children:[a.name," ",e.jsxs("span",{className:"text-muted text-xs",children:["(",a.email,")"]})]})]},a.id))})]}),!A&&L.size===0&&e.jsx("p",{className:"text-muted text-xs",children:"No buddies selected â€” SOS will auto-select the best available buddies."})]})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:j,children:j?"Submitting...":f?"Submit Check-in + Send SOS":"Submit Check-in"})]})]})}const V=[{value:"AVAILABLE",label:"Available",dotClass:"status-dot-available",activeClass:"presence-btn-available-active"},{value:"BUSY",label:"Busy",dotClass:"status-dot-busy",activeClass:"presence-btn-busy-active"},{value:"OFFLINE",label:"Offline",dotClass:"status-dot-offline",activeClass:"presence-btn-offline-active"}];function ie({onUpdated:t}){const[c,m]=s.useState("OFFLINE"),[o,x]=s.useState("OFFLINE"),[b,h]=s.useState(!1),[i,p]=s.useState(!0),[S,N]=s.useState(null),[j,u]=s.useState(!1),k=o!==c;s.useEffect(()=>{U().then(r=>{const f=r.status;m(f),x(f)}).catch(()=>{}).finally(()=>p(!1))},[]);async function d(){h(!0),N(null);try{await Y(o),m(o),t==null||t(o),u(!0),setTimeout(()=>u(!1),2e3)}catch(r){N(r instanceof Error?r.message:"Failed to update")}finally{h(!1)}}const g=V.find(r=>r.value===o);return i?e.jsx("div",{className:"card mb-4",children:e.jsx("p",{className:"text-secondary text-sm",children:"Loading status..."})}):e.jsxs("div",{className:"card mb-4",children:[e.jsxs("div",{className:"flex-between mb-4",children:[e.jsxs("div",{className:"flex-center gap-sm",children:[e.jsx("h3",{className:"heading-sm",children:"My Status"}),e.jsx("span",{className:`status-dot ${(g==null?void 0:g.dotClass)??"status-dot-offline"}`})]}),e.jsx("span",{className:"text-secondary text-sm",children:g==null?void 0:g.label})]}),e.jsx("div",{className:"presence-options",children:V.map(r=>{const f=o===r.value;return e.jsxs("button",{type:"button",className:`presence-btn ${f?r.activeClass:""}`,onClick:()=>x(r.value),disabled:b,children:[e.jsx("span",{className:`status-dot ${r.dotClass}`}),e.jsx("span",{className:"presence-btn-label",children:r.label})]},r.value)})}),k&&e.jsxs("div",{style:{marginTop:"0.75rem",display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("button",{type:"button",className:"btn btn-primary btn-sm",onClick:d,disabled:b,children:b?"Saving...":j?"Saved!":"Submit"}),e.jsx("span",{style:{fontSize:"0.8rem",color:"var(--color-warning)"},children:"Unsaved â€” click Submit to apply"})]}),S&&e.jsx("p",{className:"text-danger text-sm mt-3",children:S})]})}const T="komrade:profile-updated";function le(){window.dispatchEvent(new Event(T))}function ce(t){return window.addEventListener(T,t),()=>window.removeEventListener(T,t)}function de({onUpdated:t}){const[c,m]=s.useState(""),[o,x]=s.useState([]),[b,h]=s.useState(!1),[i,p]=s.useState(null),[S,N]=s.useState(null),[j,u]=s.useState(""),[k,d]=s.useState(!1),[g,r]=s.useState(!1),[f,w]=s.useState(null),[O,F]=s.useState(!1),[A,$]=s.useState(!0),[L,_]=s.useState(!1);async function B(){try{const l=I();if(!l)return;const n=await G(l);if(n.latitude!==null&&n.longitude!==null){const y={lat:n.latitude,lng:n.longitude};p(y),N(y);try{const v=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${n.latitude}&lon=${n.longitude}&format=json`,{headers:{"Accept-Language":"en"}});if(v.ok){const P=(await v.json()).display_name||`${n.latitude.toFixed(4)}, ${n.longitude.toFixed(4)}`;u(P),m(P)}else{const D=`${n.latitude.toFixed(4)}, ${n.longitude.toFixed(4)}`;u(D),m(D)}}catch{const v=`${n.latitude.toFixed(4)}, ${n.longitude.toFixed(4)}`;u(v),m(v)}}}catch{}}s.useEffect(()=>{let l=!0;async function n(){await B(),l&&$(!1)}n();const y=()=>{B().catch(()=>{})},v=()=>{document.visibilityState==="visible"&&B().catch(()=>{})};return window.addEventListener("focus",y),document.addEventListener("visibilitychange",v),()=>{l=!1,window.removeEventListener("focus",y),document.removeEventListener("visibilitychange",v)}},[]);async function M(l){m(l),F(!1),u(""),h(!0);const n=await Z(l);x(n),h(!1)}function a(l){m(l.display_name),u(l.display_name),x([]),p({lat:l.lat,lng:l.lon}),w(null),F(!1),_(!0)}async function C(){r(!0),w(null),F(!1);try{const l=await fetch("https://ipapi.co/json/");if(!l.ok)throw new Error("IP geolocation service unavailable");const n=await l.json();if(n.latitude&&n.longitude){const y=n.latitude,v=n.longitude;p({lat:y,lng:v});const D=[n.city,n.region,n.country_name].filter(Boolean).join(", ");u(D||`${y.toFixed(4)}, ${v.toFixed(4)}`),m(D||""),_(!0)}else throw new Error("Could not determine location from IP")}catch(l){w(l instanceof Error?l.message:"Auto-detect failed. Please type your address above.")}finally{r(!1)}}async function E(){if(i){d(!0),w(null);try{await z(i.lat,i.lng),await B(),F(!0),_(!1),le(),t==null||t()}catch(l){w(l instanceof Error?l.message:"Failed to update location")}finally{d(!1)}}}return A?e.jsxs("div",{className:"card mb-4",children:[e.jsx("h3",{className:"heading-sm mb-3",children:"My Location"}),e.jsx("p",{className:"text-muted text-sm",children:"Loading saved location..."})]}):e.jsxs("div",{className:"card mb-4",children:[e.jsx("h3",{className:"heading-sm mb-4",children:"My Location"}),S&&j&&!O&&e.jsx("div",{className:"location-current-badge mb-4",children:e.jsx("span",{className:"text-sm",children:j.split(",").slice(0,3).join(", ")})}),e.jsxs("div",{className:"input-group mb-3 relative",children:[e.jsx("label",{children:"Search Address"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",className:`input ${O?"location-input-success":L?"location-input-dirty":""}`,value:c,onChange:l=>M(l.target.value),placeholder:"Type city, ZIP code, or address to update..."}),b&&e.jsx("span",{className:"location-search-indicator text-muted text-xs",children:"Searching..."})]})]}),o.length>0&&e.jsx("div",{className:"location-suggestions-dropdown mb-3",children:o.map((l,n)=>e.jsxs("button",{type:"button",className:"location-suggestion-item",onClick:()=>a(l),children:[e.jsx("span",{className:"location-suggestion-primary",children:l.display_name.split(",")[0]}),e.jsx("span",{className:"text-muted text-xs",children:l.display_name.includes(",")?", "+l.display_name.split(",").slice(1,3).join(",").trim():""})]},n))}),e.jsxs("div",{className:"flex-between gap-sm mb-3",style:{flexWrap:"wrap"},children:[e.jsxs("button",{type:"button",className:"btn btn-ghost",onClick:C,disabled:g,children:[e.jsx("span",{children:"ðŸ“"}),g?"Detecting...":"Auto-detect"]}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:E,disabled:!L||k||!i,children:k?"Saving...":"Save Location"})]}),L&&i&&e.jsx("p",{className:"text-warning text-sm mt-2",children:'Unsaved changes â€” click "Save Location" to confirm.'}),O&&i&&e.jsxs("p",{className:"text-success text-sm mt-2",children:["Location saved: ",j?j.split(",").slice(0,2).join(", "):`${i.lat.toFixed(4)}, ${i.lng.toFixed(4)}`]}),f&&e.jsx("p",{className:"text-danger text-sm mt-2",children:f})]})}function re(t){switch(t){case"AVAILABLE":return"status-dot-available";case"BUSY":return"status-dot-busy";default:return"status-dot-offline"}}function oe(t){switch(t){case"AVAILABLE":return"badge-success";case"BUSY":return"badge-warning";default:return""}}function me(){const[t,c]=s.useState([]),[m,o]=s.useState(!0),[x,b]=s.useState(null);async function h(){b(null),o(!0);try{const i=await Q(10);c(i)}catch(i){b(i instanceof Error?i.message:"Failed to load nearby buddies")}finally{o(!1)}}return s.useEffect(()=>{h()},[]),m?e.jsx("p",{className:"text-secondary text-sm",children:"Loading nearby buddies..."}):x?e.jsx("div",{className:"alert alert-danger text-sm",children:x}):t.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No accepted buddies found."}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex-between mb-4",children:[e.jsx("span",{className:"text-muted text-xs",children:"Ranked by availability, trust, and distance"}),e.jsx("button",{type:"button",className:"btn btn-ghost btn-sm",onClick:h,children:"Refresh"})]}),e.jsx("div",{className:"flex-col gap-sm",children:t.map((i,p)=>e.jsx("div",{className:"card card-hover buddy-card",children:e.jsxs("div",{className:"buddy-card-inner",children:[e.jsxs("span",{className:"buddy-rank text-muted",children:["#",p+1]}),e.jsx("span",{className:`status-dot ${re(i.presence_status)}`}),e.jsxs("div",{className:"buddy-info",children:[e.jsx("span",{className:"buddy-name",children:i.buddy_name}),e.jsxs("span",{className:"text-muted text-xs",children:[i.buddy_email," Â· trust ",i.trust_level,"/5"]})]}),e.jsxs("div",{className:"buddy-meta",children:[e.jsx("span",{className:`badge badge-sm ${oe(i.presence_status)}`,children:i.presence_status}),i.distance_km!==null&&e.jsxs("span",{className:"text-muted text-xs",children:[i.distance_km<1?"<1":Math.round(i.distance_km)," km"]})]})]})},i.buddy_id))})]})}function ge(){const[t,c]=s.useState([]),[m,o]=s.useState([]),[x,b]=s.useState(!0),[h,i]=s.useState(""),[p,S]=s.useState(""),[N,j]=s.useState(null);async function u(){j(null);try{const d=I();if(!d){j("No token found. Please log in again."),b(!1);return}const g=await G(d);i(g.role),S(g.full_name);const[r,f]=await Promise.all([X(7),K()]);c(r),o(f)}catch(d){j(d instanceof Error?d.message:"Failed to load dashboard. Your session may have expired â€” please log in again."),c([]),o([])}finally{b(!1)}}s.useEffect(()=>(u(),ce(()=>{u()})),[]);const k=m.filter(d=>d.status==="ACCEPTED").map(d=>({id:d.buddy_id,name:d.other_name||d.other_email,email:d.other_email}));return x?e.jsxs("div",{className:"page-container animate-in",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"loading-shimmer skeleton-heading mb-4"}),e.jsx("div",{className:"loading-shimmer skeleton-text"})]}),e.jsxs("div",{className:"grid-3 mb-8",children:[e.jsx("div",{className:"card loading-shimmer skeleton-card"}),e.jsx("div",{className:"card loading-shimmer skeleton-card"}),e.jsx("div",{className:"card loading-shimmer skeleton-card"})]}),e.jsx("div",{className:"card loading-shimmer skeleton-card mb-6"}),e.jsx("div",{className:"card loading-shimmer skeleton-card"})]}):e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header animate-in",children:[e.jsxs("h1",{className:"heading-xl",children:["Welcome",p?", ":"",p&&e.jsx("span",{className:"text-gradient",children:p})]}),e.jsx("p",{className:"text-secondary text-lg mt-2",children:"VetBridge â€” Veteran Buddy Matching"}),e.jsxs("div",{className:"mt-3 flex-center gap-sm",style:{justifyContent:"flex-start"},children:[e.jsx("a",{href:"/ladder",className:"btn btn-secondary btn-sm",children:"Open Ladder"}),e.jsx("a",{href:"/translate",className:"btn btn-ghost btn-sm",children:"Open Translate"})]})]}),N&&e.jsx("div",{className:"alert alert-danger animate-in mb-6",children:e.jsxs("div",{children:[e.jsx("p",{className:"mb-2",children:N}),e.jsx("a",{href:"/login",className:"btn btn-ghost btn-sm",children:"Go to Login"})]})}),h&&e.jsxs("section",{className:"card mb-6 animate-in animate-in-delay-1",children:[e.jsx("h2",{className:"heading-md mb-4",children:"Status & Location"}),e.jsxs("div",{className:"flex-col gap-md",children:[e.jsx(ie,{}),e.jsx(de,{onUpdated:u})]})]}),h==="veteran"&&e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"card mb-6 animate-in animate-in-delay-2",children:[e.jsx("h2",{className:"heading-md mb-2",children:"Nearby Buddies"}),e.jsx("p",{className:"text-secondary text-sm mb-4",children:"These are the buddies who will be notified during SOS"}),e.jsx(me,{})]}),e.jsxs("section",{className:"card mb-6 animate-in animate-in-delay-3",children:[e.jsx("h2",{className:"heading-md mb-4",children:"Mood Check-in"}),e.jsx(ne,{onSubmitted:u,buddies:k}),e.jsx("hr",{className:"divider"}),e.jsx("h3",{className:"heading-sm mb-3",children:"Recent check-ins (last 7)"}),t.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No check-ins yet. Submit your first one above."}):e.jsx("div",{className:"flex-col gap-sm",children:t.map(d=>e.jsx(te,{checkin:d},d.id))})]})]}),h!=="veteran"&&h&&e.jsx("div",{className:"card animate-in animate-in-delay-1",children:e.jsx("p",{className:"text-secondary",children:"Mood check-ins and SOS are available for veterans."})})]})}export{ge as default};
