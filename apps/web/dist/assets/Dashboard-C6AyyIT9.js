import{g as $,a as G,p as W,j as e,r as s,c as V,b as H,u as R,d as Y,e as z,f as Q}from"./index-D52GenFk.js";import{g as P,u as K}from"./auth-CHILJdX7.js";import{s as U}from"./geocode-Cak2rTCs.js";async function Z(t){const i=$();if(!i)throw new Error("Not authenticated");return W("/checkins",t,i)}async function J(t=30){const i=$();if(!i)throw new Error("Not authenticated");return G(`/checkins/me?limit=${t}`,i)}const X={1:"Very low",2:"Low",3:"Okay",4:"Good",5:"Great"};function q(t){const i=new Date(t),o=new Date().toDateString(),x=i.toDateString();return o===x?`Today ${i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`:i.toLocaleDateString(void 0,{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function ee(t){return t<=2?"mood-score-low":t===3?"mood-score-mid":"mood-score-high"}function se({checkin:t}){return e.jsxs("div",{className:"card card-hover mb-3",children:[e.jsxs("div",{className:"flex-between mb-3",style:{flexWrap:"wrap",gap:"4px"},children:[e.jsxs("div",{className:"flex-center gap-sm",children:[e.jsx("span",{className:`mood-score-badge ${ee(t.mood_score)}`,children:t.mood_score}),e.jsx("span",{className:"heading-sm",children:X[t.mood_score]??"Unknown"})]}),e.jsx("span",{className:"text-muted text-xs",children:q(t.created_at)})]}),t.tags.length>0&&e.jsx("div",{className:"flex-center gap-xs mb-3",style:{flexWrap:"wrap",justifyContent:"flex-start"},children:t.tags.map(i=>e.jsx("span",{className:"badge",children:i},i))}),t.note&&e.jsx("p",{className:"text-secondary text-sm mb-2",children:t.note}),t.wants_company&&e.jsx("div",{className:"flex-center gap-xs mt-2",style:{justifyContent:"flex-start"},children:e.jsx("span",{className:"badge badge-info",children:"Wants company"})})]})}const te=[{value:1,label:"1 - Very low"},{value:2,label:"2 - Low"},{value:3,label:"3 - Okay"},{value:4,label:"4 - Good"},{value:5,label:"5 - Great"}];function ae({onSubmitted:t,buddies:i,onSosCreated:u}){const[o,x]=s.useState(3),[p,h]=s.useState(""),[n,f]=s.useState(""),[v,N]=s.useState(!1),[y,g]=s.useState(!1),[S,c]=s.useState(null),[b,d]=s.useState(null),[j,k]=s.useState(!1),[E,_]=s.useState("MED"),[O,F]=s.useState(!1),[w,L]=s.useState(new Set);function M(a){L(C=>{const l=new Set(C);return l.has(a)?l.delete(a):l.add(a),l})}async function D(a){a.preventDefault(),c(null),d(null),g(!0);try{const C=p.split(/[,\s]+/).map(m=>m.trim()).filter(Boolean),l={mood_score:o,tags:C,note:n.trim()||void 0,wants_company:v};if(await Z(l),j){const m={};O?m.broadcast=!0:w.size>0&&(m.buddy_ids=Array.from(w));try{const r=await V(E,m);u==null||u(r),d(`Check-in submitted + SOS #${r.id} sent!`)}catch(r){d("Check-in submitted."),c(r instanceof Error?r.message:"Check-in OK but SOS failed")}}else d("Check-in submitted.");x(3),h(""),f(""),N(!1),k(!1),F(!1),L(new Set),t()}catch(C){c(C instanceof Error?C.message:"Failed to submit check-in")}finally{g(!1)}}return e.jsxs("form",{onSubmit:D,className:"card mb-6",children:[e.jsx("h3",{className:"heading-sm mb-4",children:"How are you feeling today?"}),e.jsx("div",{className:"divider mb-4"}),S&&e.jsx("div",{className:"alert alert-danger mb-4 text-sm",children:S}),b&&e.jsx("div",{className:"alert alert-success mb-4 text-sm",children:b}),e.jsxs("div",{className:"flex-col gap-md",children:[e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Mood (1-5)"}),e.jsx("select",{className:"select",value:o,onChange:a=>x(Number(a.target.value)),children:te.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Tags (comma-separated)"}),e.jsx("input",{type:"text",className:"input",value:p,onChange:a=>h(a.target.value),placeholder:"calm, hopeful, tired..."})]}),e.jsxs("div",{className:"input-group",children:[e.jsx("label",{children:"Note (optional)"}),e.jsx("textarea",{className:"textarea",value:n,onChange:a=>f(a.target.value),placeholder:"How are you doing?",rows:3})]}),e.jsxs("label",{className:"mood-company-checkbox",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:a=>N(a.target.checked)}),e.jsx("span",{className:"text-secondary text-sm",children:"I'd like company today"})]}),e.jsx("div",{className:"divider"}),e.jsxs("div",{className:"form-section",children:[e.jsxs("label",{className:"mood-company-checkbox",style:{marginBottom:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:j,onChange:a=>k(a.target.checked)}),e.jsx("span",{className:"text-sm",style:{fontWeight:600},children:"Send SOS Alert with this check-in"})]}),j&&e.jsxs("div",{className:"flex-col gap-sm",style:{marginTop:"0.75rem",paddingLeft:"0.5rem"},children:[e.jsxs("div",{className:"input-group",children:[e.jsx("label",{className:"text-secondary text-sm",children:"Severity"}),e.jsx("div",{className:"flex-center gap-sm mt-1",children:["LOW","MED","HIGH"].map(a=>e.jsx("button",{type:"button",className:`btn btn-sm ${E===a?a==="HIGH"?"btn-danger":a==="MED"?"btn-secondary":"btn-success":"btn-ghost"}`,onClick:()=>_(a),children:a},a))})]}),e.jsxs("label",{className:"mood-company-checkbox",children:[e.jsx("input",{type:"checkbox",checked:O,onChange:a=>{F(a.target.checked),a.target.checked&&L(new Set)}}),e.jsx("span",{className:"text-secondary text-sm",children:"Broadcast to all buddies"})]}),!O&&i.length>0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-secondary text-sm",style:{display:"block",marginBottom:"0.4rem"},children:"Or select specific buddies:"}),e.jsx("div",{className:"flex-col gap-xs",children:i.map(a=>e.jsxs("label",{className:"mood-company-checkbox",children:[e.jsx("input",{type:"checkbox",checked:w.has(a.id),onChange:()=>M(a.id)}),e.jsxs("span",{className:"text-sm",children:[a.name," ",e.jsxs("span",{className:"text-muted text-xs",children:["(",a.email,")"]})]})]},a.id))})]}),!O&&w.size===0&&e.jsx("p",{className:"text-muted text-xs",children:"No buddies selected â€” SOS will auto-select the best available buddies."})]})]}),e.jsx("button",{type:"submit",className:"btn btn-primary",disabled:y,children:y?"Submitting...":j?"Submit Check-in + Send SOS":"Submit Check-in"})]})]})}const T=[{value:"AVAILABLE",label:"Available",dotClass:"status-dot-available",activeClass:"presence-btn-available-active"},{value:"BUSY",label:"Busy",dotClass:"status-dot-busy",activeClass:"presence-btn-busy-active"},{value:"OFFLINE",label:"Offline",dotClass:"status-dot-offline",activeClass:"presence-btn-offline-active"}];function ne({onUpdated:t}){const[i,u]=s.useState("OFFLINE"),[o,x]=s.useState("OFFLINE"),[p,h]=s.useState(!1),[n,f]=s.useState(!0),[v,N]=s.useState(null),[y,g]=s.useState(!1),S=o!==i;s.useEffect(()=>{H().then(d=>{const j=d.status;u(j),x(j)}).catch(()=>{}).finally(()=>f(!1))},[]);async function c(){h(!0),N(null);try{await R(o),u(o),t==null||t(o),g(!0),setTimeout(()=>g(!1),2e3)}catch(d){N(d instanceof Error?d.message:"Failed to update")}finally{h(!1)}}const b=T.find(d=>d.value===o);return n?e.jsx("div",{className:"card mb-4",children:e.jsx("p",{className:"text-secondary text-sm",children:"Loading status..."})}):e.jsxs("div",{className:"card mb-4",children:[e.jsxs("div",{className:"flex-between mb-4",children:[e.jsxs("div",{className:"flex-center gap-sm",children:[e.jsx("h3",{className:"heading-sm",children:"My Status"}),e.jsx("span",{className:`status-dot ${(b==null?void 0:b.dotClass)??"status-dot-offline"}`})]}),e.jsx("span",{className:"text-secondary text-sm",children:b==null?void 0:b.label})]}),e.jsx("div",{className:"presence-options",children:T.map(d=>{const j=o===d.value;return e.jsxs("button",{type:"button",className:`presence-btn ${j?d.activeClass:""}`,onClick:()=>x(d.value),disabled:p,children:[e.jsx("span",{className:`status-dot ${d.dotClass}`}),e.jsx("span",{className:"presence-btn-label",children:d.label})]},d.value)})}),S&&e.jsxs("div",{style:{marginTop:"0.75rem",display:"flex",alignItems:"center",gap:"0.75rem"},children:[e.jsx("button",{type:"button",className:"btn btn-primary btn-sm",onClick:c,disabled:p,children:p?"Saving...":y?"Saved!":"Submit"}),e.jsx("span",{style:{fontSize:"0.8rem",color:"var(--color-warning)"},children:"Unsaved â€” click Submit to apply"})]}),v&&e.jsx("p",{className:"text-danger text-sm mt-3",children:v})]})}function le({onUpdated:t}){const[i,u]=s.useState(""),[o,x]=s.useState([]),[p,h]=s.useState(!1),[n,f]=s.useState(null),[v,N]=s.useState(null),[y,g]=s.useState(""),[S,c]=s.useState(!1),[b,d]=s.useState(!1),[j,k]=s.useState(null),[E,_]=s.useState(!1),[O,F]=s.useState(!0),[w,L]=s.useState(!1);s.useEffect(()=>{async function l(){try{const m=$();if(!m)return;const r=await P(m);if(r.latitude&&r.longitude){const B={lat:r.latitude,lng:r.longitude};f(B),N(B);try{const A=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${r.latitude}&lon=${r.longitude}&format=json`,{headers:{"Accept-Language":"en"}});if(A.ok){const I=(await A.json()).display_name||`${r.latitude.toFixed(4)}, ${r.longitude.toFixed(4)}`;g(I),u(I)}else g(`${r.latitude.toFixed(4)}, ${r.longitude.toFixed(4)}`)}catch{g(`${r.latitude.toFixed(4)}, ${r.longitude.toFixed(4)}`)}}}catch{}finally{F(!1)}}l()},[]);async function M(l){u(l),_(!1),g(""),h(!0);const m=await U(l);x(m),h(!1)}function D(l){u(l.display_name),g(l.display_name),x([]),f({lat:l.lat,lng:l.lon}),k(null),_(!1),L(!0)}async function a(){d(!0),k(null),_(!1);try{const l=await fetch("https://ipapi.co/json/");if(!l.ok)throw new Error("IP geolocation service unavailable");const m=await l.json();if(m.latitude&&m.longitude){const r=m.latitude,B=m.longitude;f({lat:r,lng:B});const A=[m.city,m.region,m.country_name].filter(Boolean).join(", ");g(A||`${r.toFixed(4)}, ${B.toFixed(4)}`),u(A||""),L(!0)}else throw new Error("Could not determine location from IP")}catch(l){k(l instanceof Error?l.message:"Auto-detect failed. Please type your address above.")}finally{d(!1)}}async function C(){if(n){c(!0),k(null);try{await Y(n.lat,n.lng),await K({latitude:n.lat,longitude:n.lng}),N(n),_(!0),L(!1),t==null||t()}catch(l){k(l instanceof Error?l.message:"Failed to update location")}finally{c(!1)}}}return O?e.jsxs("div",{className:"card mb-4",children:[e.jsx("h3",{className:"heading-sm mb-3",children:"My Location"}),e.jsx("p",{className:"text-muted text-sm",children:"Loading saved location..."})]}):e.jsxs("div",{className:"card mb-4",children:[e.jsx("h3",{className:"heading-sm mb-4",children:"My Location"}),v&&y&&!E&&e.jsx("div",{className:"location-current-badge mb-4",children:e.jsx("span",{className:"text-sm",children:y.split(",").slice(0,3).join(", ")})}),e.jsxs("div",{className:"input-group mb-3 relative",children:[e.jsx("label",{children:"Search Address"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",className:`input ${E?"location-input-success":w?"location-input-dirty":""}`,value:i,onChange:l=>M(l.target.value),placeholder:"Type city, ZIP code, or address to update..."}),p&&e.jsx("span",{className:"location-search-indicator text-muted text-xs",children:"Searching..."})]})]}),o.length>0&&e.jsx("div",{className:"location-suggestions-dropdown mb-3",children:o.map((l,m)=>e.jsxs("button",{type:"button",className:"location-suggestion-item",onClick:()=>D(l),children:[e.jsx("span",{className:"location-suggestion-primary",children:l.display_name.split(",")[0]}),e.jsx("span",{className:"text-muted text-xs",children:l.display_name.includes(",")?", "+l.display_name.split(",").slice(1,3).join(",").trim():""})]},m))}),e.jsxs("div",{className:"flex-between gap-sm mb-3",style:{flexWrap:"wrap"},children:[e.jsxs("button",{type:"button",className:"btn btn-ghost",onClick:a,disabled:b,children:[e.jsx("span",{children:"ðŸ“"}),b?"Detecting...":"Auto-detect"]}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:C,disabled:!w||S||!n,children:S?"Saving...":"Save Location"})]}),w&&n&&e.jsx("p",{className:"text-warning text-sm mt-2",children:'Unsaved changes â€” click "Save Location" to confirm.'}),E&&n&&e.jsxs("p",{className:"text-success text-sm mt-2",children:["Location saved: ",y?y.split(",").slice(0,2).join(", "):`${n.lat.toFixed(4)}, ${n.lng.toFixed(4)}`]}),j&&e.jsx("p",{className:"text-danger text-sm mt-2",children:j})]})}function ie(t){switch(t){case"AVAILABLE":return"status-dot-available";case"BUSY":return"status-dot-busy";default:return"status-dot-offline"}}function ce(t){switch(t){case"AVAILABLE":return"badge-success";case"BUSY":return"badge-warning";default:return""}}function de(){const[t,i]=s.useState([]),[u,o]=s.useState(!0),[x,p]=s.useState(null);async function h(){p(null),o(!0);try{const n=await z(10);i(n)}catch(n){p(n instanceof Error?n.message:"Failed to load nearby buddies")}finally{o(!1)}}return s.useEffect(()=>{h()},[]),u?e.jsx("p",{className:"text-secondary text-sm",children:"Loading nearby buddies..."}):x?e.jsx("div",{className:"alert alert-danger text-sm",children:x}):t.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No accepted buddies found."}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex-between mb-4",children:[e.jsx("span",{className:"text-muted text-xs",children:"Ranked by availability, trust, and distance"}),e.jsx("button",{type:"button",className:"btn btn-ghost btn-sm",onClick:h,children:"Refresh"})]}),e.jsx("div",{className:"flex-col gap-sm",children:t.map((n,f)=>e.jsx("div",{className:"card card-hover buddy-card",children:e.jsxs("div",{className:"buddy-card-inner",children:[e.jsxs("span",{className:"buddy-rank text-muted",children:["#",f+1]}),e.jsx("span",{className:`status-dot ${ie(n.presence_status)}`}),e.jsxs("div",{className:"buddy-info",children:[e.jsx("span",{className:"buddy-name",children:n.buddy_name}),e.jsxs("span",{className:"text-muted text-xs",children:[n.buddy_email," Â· trust ",n.trust_level,"/5"]})]}),e.jsxs("div",{className:"buddy-meta",children:[e.jsx("span",{className:`badge badge-sm ${ce(n.presence_status)}`,children:n.presence_status}),n.distance_km!==null&&e.jsxs("span",{className:"text-muted text-xs",children:[n.distance_km<1?"<1":Math.round(n.distance_km)," km"]})]})]})},n.buddy_id))})]})}function he(){const[t,i]=s.useState([]),[u,o]=s.useState([]),[x,p]=s.useState(!0),[h,n]=s.useState(""),[f,v]=s.useState(""),[N,y]=s.useState(null);async function g(){y(null);try{const c=$();if(!c){y("No token found. Please log in again."),p(!1);return}const b=await P(c);n(b.role),v(b.full_name);const[d,j]=await Promise.all([J(7),Q()]);i(d),o(j)}catch(c){y(c instanceof Error?c.message:"Failed to load dashboard. Your session may have expired â€” please log in again."),i([]),o([])}finally{p(!1)}}s.useEffect(()=>{g()},[]);const S=u.filter(c=>c.status==="ACCEPTED").map(c=>({id:c.buddy_id,name:c.other_name||c.other_email,email:c.other_email}));return x?e.jsxs("div",{className:"page-container animate-in",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"loading-shimmer skeleton-heading mb-4"}),e.jsx("div",{className:"loading-shimmer skeleton-text"})]}),e.jsxs("div",{className:"grid-3 mb-8",children:[e.jsx("div",{className:"card loading-shimmer skeleton-card"}),e.jsx("div",{className:"card loading-shimmer skeleton-card"}),e.jsx("div",{className:"card loading-shimmer skeleton-card"})]}),e.jsx("div",{className:"card loading-shimmer skeleton-card mb-6"}),e.jsx("div",{className:"card loading-shimmer skeleton-card"})]}):e.jsxs("div",{className:"page-container",children:[e.jsxs("div",{className:"page-header animate-in",children:[e.jsxs("h1",{className:"heading-xl",children:["Welcome",f?", ":"",f&&e.jsx("span",{className:"text-gradient",children:f})]}),e.jsx("p",{className:"text-secondary text-lg mt-2",children:"VetBridge â€” Veteran Buddy Matching"}),e.jsxs("div",{className:"mt-3 flex-center gap-sm",style:{justifyContent:"flex-start"},children:[e.jsx("a",{href:"/ladder",className:"btn btn-secondary btn-sm",children:"Open Ladder"}),e.jsx("a",{href:"/translate",className:"btn btn-ghost btn-sm",children:"Open Translate"})]})]}),N&&e.jsx("div",{className:"alert alert-danger animate-in mb-6",children:e.jsxs("div",{children:[e.jsx("p",{className:"mb-2",children:N}),e.jsx("a",{href:"/login",className:"btn btn-ghost btn-sm",children:"Go to Login"})]})}),h&&e.jsxs("section",{className:"card mb-6 animate-in animate-in-delay-1",children:[e.jsx("h2",{className:"heading-md mb-4",children:"Status & Location"}),e.jsxs("div",{className:"flex-col gap-md",children:[e.jsx(ne,{}),e.jsx(le,{})]})]}),h==="veteran"&&e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"card mb-6 animate-in animate-in-delay-2",children:[e.jsx("h2",{className:"heading-md mb-2",children:"Nearby Buddies"}),e.jsx("p",{className:"text-secondary text-sm mb-4",children:"These are the buddies who will be notified during SOS"}),e.jsx(de,{})]}),e.jsxs("section",{className:"card mb-6 animate-in animate-in-delay-3",children:[e.jsx("h2",{className:"heading-md mb-4",children:"Mood Check-in"}),e.jsx(ae,{onSubmitted:g,buddies:S}),e.jsx("hr",{className:"divider"}),e.jsx("h3",{className:"heading-sm mb-3",children:"Recent check-ins (last 7)"}),t.length===0?e.jsx("p",{className:"text-muted text-sm",children:"No check-ins yet. Submit your first one above."}):e.jsx("div",{className:"flex-col gap-sm",children:t.map(c=>e.jsx(se,{checkin:c},c.id))})]})]}),h!=="veteran"&&h&&e.jsx("div",{className:"card animate-in animate-in-delay-1",children:e.jsx("p",{className:"text-secondary",children:"Mood check-ins and SOS are available for veterans."})})]})}export{he as default};
